<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novo CRM - Sistema de Gesti√≥n Completo</title>
    
    <!-- Error Suppressor - DEBE IR PRIMERO -->
     <script>
        // Verificar autenticaci√≥n antes de cargar la aplicaci√≥n
        (function() {
            // Solo verificar si no estamos en la p√°gina de login
            if (!window.location.pathname.includes('login.html')) {
                const sessionData = localStorage.getItem('novo_crm_session');
                
                if (!sessionData) {
                    window.location.href = 'login.html';
                    return;
                }
                
                try {
                    const session = JSON.parse(sessionData);
                    const expiresAt = new Date(session.expiresAt);
                    const now = new Date();
                    
                    if (expiresAt <= now) {
                        localStorage.removeItem('novo_crm_session');
                        sessionStorage.removeItem('novo_crm_user');
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    // Sesi√≥n v√°lida - continuar cargando la aplicaci√≥n
                    console.log('Usuario autenticado:', session.nombre + ' ' + session.apellido);
                    
                } catch (error) {
                    console.error('Error verificando sesi√≥n:', error);
                    window.location.href = 'login.html';
                }
            }
        })();
    </script>
    <script>
    // Supresor de errores agresivo para "message channel closed"
    (function() {
        'use strict';
        
        // 1. Capturar errores no manejados de promesas
        window.addEventListener('unhandledrejection', function(event) {
            const errorMsg = event.reason?.message || String(event.reason) || '';
            
            // Lista de errores a ignorar
            const errorsToIgnore = [
                'message channel closed',
                'Extension context invalidated',
                'The message port closed',
                'Could not establish connection',
                'Receiving end does not exist',
                'message port closed before a response was received',
                'A listener indicated an asynchronous response by returning true'
            ];
            
            if (errorsToIgnore.some(error => errorMsg.toLowerCase().includes(error.toLowerCase()))) {
                console.warn('[SUPPRESSED] Extension/Channel error:', errorMsg);
                event.preventDefault();
                return false;
            }
        });
        
        // 2. Capturar errores globales
        window.addEventListener('error', function(event) {
            const errorMsg = event.message || '';
            
            if (errorMsg.includes('message channel closed') || 
                errorMsg.includes('Extension context invalidated') ||
                errorMsg.includes('listener indicated an asynchronous response')) {
                console.warn('[SUPPRESSED] Global error:', errorMsg);
                event.preventDefault();
                return false;
            }
        });
        
        // 3. Interceptar chrome.runtime si existe
        if (typeof chrome !== 'undefined' && chrome.runtime) {
            const originalSendMessage = chrome.runtime.sendMessage;
            chrome.runtime.sendMessage = function(...args) {
                try {
                    return originalSendMessage.apply(this, args);
                } catch (error) {
                    if (error.message.includes('message channel closed') ||
                        error.message.includes('Extension context invalidated')) {
                        console.warn('[SUPPRESSED] Chrome runtime error:', error.message);
                        return Promise.resolve();
                    }
                    throw error;
                }
            };
        }
        
        console.log('‚úÖ Error suppressor initialized');
    })();
    </script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <!-- Agregar en el <head> despu√©s de tus otros scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/performance.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Novo CRM</h1>
            <p>Sistema de Gesti√≥n de Relaciones con Clientes</p>
        </div>

        <div id="connection-alert" class="alert alert-error hidden">
            Error de conexi√≥n con Firebase.
        </div>

        <nav class="nav">
            <div class="nav-buttons">
                <button onclick="crmApp?.showTab('dashboard')" class="nav-btn active" data-tab="dashboard">
                    <i data-lucide="bar-chart-3"></i>
                    <span>Dashboard</span>
                </button>
                <button onclick="crmApp?.showTab('clientes')" class="nav-btn" data-tab="clientes">
                    <i data-lucide="users"></i>
                    <span>Clientes</span>
                </button>
                <button onclick="crmApp?.showTab('empleados')" class="nav-btn" data-tab="empleados">
                    <i data-lucide="user-check"></i>
                    <span>Empleados</span>
                </button>
                <button onclick="crmApp?.showTab('productos')" class="nav-btn" data-tab="productos">
                    <i data-lucide="package"></i>
                    <span>Productos</span>
                </button>
                <button onclick="crmApp?.showTab('pedidos')" class="nav-btn" data-tab="pedidos">
                    <i data-lucide="shopping-cart"></i>
                    <span>Pedidos</span>
                </button>
                <button onclick="crmApp?.showTab('compras')" class="nav-btn" data-tab="compras">
                    <i data-lucide="shopping-bag"></i>
                    <span>Compras</span>
                </button>
                <button onclick="crmApp?.showTab('proveedores')" class="nav-btn" data-tab="proveedores">
                    <i data-lucide="truck"></i>
                    <span>Proveedores</span>
                </button>
                <button onclick="crmApp?.showTab('estados')" class="nav-btn" data-tab="estados">
                    <i data-lucide="flag"></i>
                    <span>Estados</span>
                </button>
                <button onclick="crmApp?.showTab('entregas')" class="nav-btn" data-tab="entregas">
                    <i data-lucide="package-check"></i>
                    <span>Entregas</span>
                </button>
                <button onclick="crmApp?.showTab('tipos-contacto')" class="nav-btn" data-tab="tipos-contacto">
                    <i data-lucide="contact"></i>
                    <span>Tipos Contacto</span>
                </button>
                <button onclick="crmApp?.showTab('tipos-pago')" class="nav-btn" data-tab="tipos-pago">
                    <i data-lucide="credit-card"></i>
                    <span>Tipos Pago</span>
                </button>
                <button onclick="crmApp?.showTab('tipos-trabajador')" class="nav-btn" data-tab="tipos-trabajador">
                    <i data-lucide="briefcase"></i>
                    <span>Tipos Trabajador</span>
                </button>
                <button onclick="crmApp?.showTab('reportes-ventas')" class="nav-btn" data-tab="reportes-ventas">
                    <i data-lucide="trending-up"></i>
                    <span>Reportes Ventas</span>
                </button>
                <button onclick="crmApp?.showTab('reportes-compras')" class="nav-btn" data-tab="reportes-compras">
                    <i data-lucide="shopping-bag"></i>
                    <span>Reportes Compras</span>
                </button>
                <button onclick="crmApp?.showTab('reportes-productos')" class="nav-btn" data-tab="reportes-productos">
                    <i data-lucide="package"></i>
                    <span>Reportes Productos</span>
                </button>
                <button onclick="crmApp?.showTab('balance')" class="nav-btn" data-tab="balance">
                    <i data-lucide="trending-up"></i>
                    <span>Balance</span>
                </button>
                <button onclick="crmApp?.showTab('cambiar-password')" class="nav-btn" data-tab="cambiar-password">
                    <i data-lucide="key"></i>
                    <span>Cambiar Contrase√±a</span>
                </button>
                <div class="nav-user">
                    <span id="current-user-name">Usuario</span>
                    <button onclick="logout()" class="btn-logout" title="Cerrar Sesi√≥n">
                        <i data-lucide="log-out"></i>
                    </button>
                </div>
            </div>
            
        </nav>

        <div class="content-area">
            <!-- Dashboard -->
            <div id="dashboard" class="tab-content active">
                <h2 class="section-title text-center">Panel de Control</h2>
                <div class="stats-grid" id="stats-grid">
                    <div class="loading"></div>
                </div>
            </div>

            <!-- Clientes -->
            <div id="clientes" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">Gesti√≥n de Clientes</h2>
                    <button onclick="openModal('cliente')" class="btn btn-primary">
                        <i data-lucide="plus"></i>
                        Agregar
                    </button>
                </div>
                <div class="table-controls">
                    <div class="search-box">
                        <i data-lucide="search" class="search-icon"></i>
                        <input type="text" id="clientes-search" class="search-input" placeholder="Buscar clientes...">
                    </div>
                </div>
                <div class="table-container" id="clientes-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Tipo</th>
                                <th>Tel√©fono</th>
                                <th>Email</th>
                                <th>Ubicaci√≥n</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="clientes-table">
                            <tr><td colspan="7" class="text-center"><div class="loading"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Empleados -->
            <div id="empleados" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">Gesti√≥n de Empleados</h2>
                    <button onclick="openModal('empleado')" class="btn btn-primary">
                        <i data-lucide="plus"></i>
                        Agregar
                    </button>
                </div>
                <div class="table-controls">
                    <div class="search-box">
                        <i data-lucide="search" class="search-icon"></i>
                        <input type="text" id="empleados-search" class="search-input" placeholder="Buscar empleados...">
                    </div>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>DNI</th>
                                <th>Nombre</th>
                                <th>Apellido</th>
                                <th>Email</th>
                                <th>Tel√©fono</th>
                                <th>Tipo</th>
                                <th>Fecha Ingreso</th>
                                <th>Fecha Salida</th>
                                <th>Lugar</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="empleados-table">
                            <tr><td colspan="11" class="text-center"><div class="loading"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Productos -->
            <div id="productos" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">Gesti√≥n de Productos</h2>
                    <button onclick="openModal('producto')" class="btn btn-primary">
                        <i data-lucide="plus"></i>
                        Agregar
                    </button>
                </div>
                <div class="table-controls">
                    <div class="search-box">
                        <i data-lucide="search" class="search-icon"></i>
                        <input type="text" id="productos-search" class="search-input" placeholder="Buscar productos...">
                    </div>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Cantidad</th>
                                <th>Precio</th>
                                <th>Observaciones</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="productos-table">
                            <tr><td colspan="6" class="text-center"><div class="loading"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pedidos - ACTUALIZADA -->
            <div id="pedidos" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">Gesti√≥n de Pedidos</h2>
                    <button onclick="openModal('pedido')" class="btn btn-primary">
                        <i data-lucide="plus"></i>
                        Agregar
                    </button>
                </div>
                <div class="table-controls">
                    <div class="search-box">
                        <i data-lucide="search" class="search-icon"></i>
                        <input type="text" id="pedidos-search" class="search-input" placeholder="Buscar pedidos...">
                    </div>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>N√∫mero</th>
                                <th>Cliente</th>
                                <th>Fecha Venta</th>
                                <th>Fecha Entrega</th>
                                <th>Total</th>
                                <th>Opci√≥n Pago</th>
                                <th>Tipo Pago</th>
                                <th>Entrega</th>
                                <th>Empleado</th>
                                <th>Estado Servicio</th>
                                <th>Fecha Pago Parcial</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="pedidos-table">
                            <tr><td colspan="12" class="text-center"><div class="loading"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- compras -->
            <div id="compras" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">Gesti√≥n de Compras</h2>
                    <button onclick="openModal('compra')" class="btn btn-primary">
                        <i data-lucide="plus"></i>
                        Agregar
                    </button>
                </div>
                <div class="table-controls">
                    <div class="search-box">
                        <i data-lucide="search" class="search-icon"></i>
                        <input type="text" id="compras-search" class="search-input" placeholder="Buscar compras...">
                    </div>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>N√∫mero</th>
                                <th>Proveedor</th>
                                <th>Fecha Compra</th>
                                <th>Fecha Recepci√≥n</th>
                                <th>Subtotal</th>
                                <th>Flete</th>
                                <th>Aduanas</th>
                                <th>Total Final</th>
                                <th>Tipo Pago</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="compras-table">
                            <tr><td colspan="11" class="text-center"><div class="loading"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tipos de Pago -->
            <div id="tipos-pago" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">Tipos de Pago</h2>
                    <button onclick="openModal('tipo-pago')" class="btn btn-primary">
                        <i data-lucide="plus"></i>
                        Agregar
                    </button>
                </div>
                <div class="table-controls">
                    <div class="search-box">
                        <i data-lucide="search" class="search-icon"></i>
                        <input type="text" id="tipos-pago-search" class="search-input" placeholder="Buscar tipos de pago...">
                    </div>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Descripci√≥n</th>
                                <th>Detalle</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tipos-pago-table">
                            <tr><td colspan="3" class="text-center"><div class="loading"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tipos de Trabajador -->
            <div id="tipos-trabajador" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">Tipos de Trabajador</h2>
                    <button onclick="openModal('tipo-trabajador')" class="btn btn-primary">
                        <i data-lucide="plus"></i>
                        Agregar
                    </button>
                </div>
                <div class="table-controls">
                    <div class="search-box">
                        <i data-lucide="search" class="search-icon"></i>
                        <input type="text" id="tipos-trabajador-search" class="search-input" placeholder="Buscar tipos...">
                    </div>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Descripci√≥n</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tipos-trabajador-table">
                            <tr><td colspan="2" class="text-center"><div class="loading"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!--  ------------------------------ -->

            <!-- Reportes de Ventas -->
            <div id="reportes-ventas" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">Reportes de Ventas</h2>
                </div>

                <!-- Filtros de Ventas -->
                <div class="filters-container">
                    <div class="filters-title">
                        <i data-lucide="filter"></i>
                        Filtros de B√∫squeda
                    </div>
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label class="filter-label">Fecha Desde</label>
                            <input type="date" id="ventas-fecha-desde" class="filter-input">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Fecha Hasta</label>
                            <input type="date" id="ventas-fecha-hasta" class="filter-input">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Cliente</label>
                            <select id="ventas-cliente" class="filter-select">
                                <option value="">Todos los clientes</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Empleado</label>
                            <select id="ventas-empleado" class="filter-select">
                                <option value="">Todos los empleados</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Estado de Servicio</label>
                            <select id="ventas-estado-servicio" class="filter-select">
                                <option value="">Todos los estados de servicio</option>
                                <option value="Pendiente">Pendiente</option>
                                <option value="Terminado">Terminado</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Tipo de Pago</label>
                            <select id="ventas-tipo-pago" class="filter-select">
                                <option value="">Todos los tipos</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Monto Desde</label>
                            <input type="number" id="ventas-monto-desde" class="filter-input" placeholder="S/ 0.00" step="0.01">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Monto Hasta</label>
                            <input type="number" id="ventas-monto-hasta" class="filter-input" placeholder="S/ 0.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">N√∫mero de Pedido:</label>
                            <input type="text" 
                                id="ventas-numero-pedido" 
                                class="form-input" 
                                placeholder="Ej: 2024-001">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Agrupar por:</label>
                            <select id="ventas-agrupacion" class="form-input" onchange="window.reportesManager?.actualizarGraficoVentas()">
                                <option value="a√±o">üìÖ A√±o</option>
                                <option value="mes" selected>üìÜ Mes</option>
                                <option value="semana">üìä Semana</option>
                                <option value="dia">üóìÔ∏è D√≠a</option>
                            </select>
                        </div>
                    </div>
                    <div class="filters-actions">
                        <button onclick="window.reportesManager?.aplicarFiltrosVentas()" class="btn btn-primary">
                            <i data-lucide="search"></i>
                            Aplicar Filtros
                        </button>
                        <button onclick="window.reportesManager?.limpiarFiltrosVentas()" class="btn btn-secondary">
                            <i data-lucide="x-circle"></i>
                            Limpiar
                        </button>
                        <button onclick="window.reportesManager?.exportarVentas()" class="btn btn-primary">
                            <i data-lucide="download"></i>
                            Exportar Excel
                        </button>
                    </div>
                </div>

                <!-- Estad√≠sticas de Ventas -->
                <div class="stats-grid" id="ventas-stats">
                    <div class="stat-card blue">
                        <div class="stat-number" id="ventas-total-registros">0</div>
                        <div class="stat-label">Total de Ventas</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-number" id="ventas-monto-total">S/ 0.00</div>
                        <div class="stat-label">Monto Total</div>
                    </div>
                    <div class="stat-card purple">
                        <div class="stat-number" id="ventas-promedio">S/ 0.00</div>
                        <div class="stat-label">Venta Promedio</div>
                    </div>
                    <div class="stat-card yellow">
                        <div class="stat-number" id="ventas-pendientes">0</div>
                        <div class="stat-label">Pendientes</div>
                    </div>
                </div>

                <!-- Gr√°fico de Ventas -->
                <div class="chart-container">
                    <div class="chart-title">Evoluci√≥n de Ventas por Mes</div>
                    <canvas id="ventasChart" width="400" height="200"></canvas>
                </div>

                <!-- Tabla de Ventas COMPLETA -->
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>N¬∞ Pedido</th>
                            <th>Cliente</th>
                            <th>Fecha Venta</th>
                            <th>Fecha Entrega</th>
                            <th>Total</th>
                            <th>Opci√≥n Pago</th>
                            <th>Tipo Pago</th>
                            <th>Entrega</th>
                            <th>Empleado</th>
                            <th>Estado Servicio</th>
                            <th>Fecha Pago Parcial</th>
                            <th>Detalle</th> 
                        </tr>
                    </thead>
                    <tbody id="ventas-table">
                        <tr><td colspan="12" class="text-center"><div class="loading"></div></td></tr>
                    </tbody>
                </table>
            </div>
            </div>

            <!-- Reportes de Compras -->
            <div id="reportes-compras" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">Reportes de Compras</h2>
                </div>

                <!-- Filtros de Compras -->
                <div class="filters-container">
                    <div class="filters-title">
                        <i data-lucide="filter"></i>
                        Filtros de B√∫squeda
                    </div>
                    <!-- Reemplazar la secci√≥n de filtros en tu HTML de reportes-compras -->
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label class="filter-label">Fecha Desde</label>
                            <input type="date" id="compras-fecha-desde" class="filter-input">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Fecha Hasta</label>
                            <input type="date" id="compras-fecha-hasta" class="filter-input">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Proveedor</label>
                            <select id="compras-proveedor" class="filter-select">
                                <option value="">Cargando proveedores...</option>
                            </select>
                        </div>
                        <!-- FIX 2: Reemplazar "Estado" por "Estado de Servicio" -->
                        <div class="filter-group">
                            <label class="filter-label">Estado de Servicio</label>
                            <select id="compras-estado-servicio" class="filter-select">
                                <option value="">Todos los estados</option>
                                <option value="Pendiente">Pendiente</option>
                                <option value="Terminado">Terminado</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Tipo de Pago</label>
                            <select id="compras-tipo-pago" class="filter-select">
                                <option value="">Todos los tipos</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Monto Desde</label>
                            <input type="number" id="compras-monto-desde" class="filter-input" placeholder="S/ 0.00" step="0.01">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Monto Hasta</label>
                            <input type="number" id="compras-monto-hasta" class="filter-input" placeholder="S/ 0.00" step="0.01">
                        </div>
                        <!-- FIX 3: Reemplazar "Incluir Flete" por "N√∫mero de Compra" -->
                        <div class="filter-group">
                            <label class="filter-label">N√∫mero de Compra</label>
                            <input type="text" id="compras-numero-compra" class="filter-input" placeholder="Ej: C20250828">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Agrupar por:</label>
                            <select id="compras-agrupacion" class="form-input" onchange="window.reportesManager?.actualizarGraficoCompras()">
                                <option value="a√±o">üìÖ A√±o</option>
                                <option value="mes" selected>üìÜ Mes</option>
                                <option value="semana">üìä Semana</option>
                                <option value="dia">üóìÔ∏è D√≠a</option>
                            </select>
                        </div>
                    </div>
                    <div class="filters-actions">
                        <button onclick="window.reportesManager?.aplicarFiltrosCompras()" class="btn btn-primary">
                            <i data-lucide="search"></i>
                            Aplicar Filtros
                        </button>
                        <button onclick="window.reportesManager?.limpiarFiltrosCompras()" class="btn btn-secondary">
                            <i data-lucide="x-circle"></i>
                            Limpiar
                        </button>
                        <button onclick="window.reportesManager?.exportarCompras()" class="btn btn-primary">
                            <i data-lucide="download"></i>
                            Exportar Excel
                        </button>
                    </div>
                </div>
                <!-- Estad√≠sticas de Compras -->
                <div class="stats-grid" id="compras-stats">
                    <div class="stat-card blue">
                        <div class="stat-number" id="compras-total-registros">0</div>
                        <div class="stat-label">Total de Compras</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-number" id="compras-subtotal">S/ 0.00</div>
                        <div class="stat-label">Subtotal</div>
                    </div>
                    <div class="stat-card yellow">
                        <div class="stat-number" id="compras-flete-total">S/ 0.00</div>
                        <div class="stat-label">Flete Total</div>
                    </div>
                    <div class="stat-card indigo">
                        <div class="stat-number" id="compras-aduanas-total">S/ 0.00</div>
                        <div class="stat-label">Aduanas Total</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-number" id="compras-total-final">S/ 0.00</div>
                        <div class="stat-label">Total Final</div>
                    </div>
                    <div class="stat-card purple">
                        <div class="stat-number" id="compras-promedio">S/ 0.00</div>
                        <div class="stat-label">Compra Promedio</div>
                    </div>
                </div>

                <!-- Gr√°fico de Compras -->
                <div class="chart-container">
                    <div class="chart-title">Evoluci√≥n de Compras por Mes</div>
                    <canvas id="comprasChart" width="400" height="200"></canvas>
                </div>

                <!-- Tabla de Compras -->
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>N¬∞ Compra</th>
                                <th>Fecha Compra</th>
                                <th>Proveedor</th>
                                <th>Subtotal</th>
                                <th>Flete</th>
                                <th>Aduanas</th>
                                <th>Total Final</th>
                                <th>Tipo Pago</th>
                                <th>Estado</th>
                                <th>Fecha Recepci√≥n</th>
                                <th>Detalle</th>
                            </tr>
                        </thead>
                        <tbody id="compras-table">
                            <tr><td colspan="10" class="text-center"><div class="loading"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Proveedores -->
            <div id="proveedores" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">Gesti√≥n de Proveedores</h2>
                    <button onclick="openModal('proveedor')" class="btn btn-primary">
                        <i data-lucide="plus"></i>
                        Agregar
                    </button>
                </div>
                <div class="table-controls">
                    <div class="search-box">
                        <i data-lucide="search" class="search-icon"></i>
                        <input type="text" id="proveedores-search" class="search-input" placeholder="Buscar proveedores...">
                    </div>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Tel√©fono</th>
                                <th>Email</th>
                                <th>Direcci√≥n</th>
                                <th>Lugar</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="proveedores-table">
                            <tr><td colspan="7" class="text-center"><div class="loading"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Estados -->
            <div id="estados" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">Gesti√≥n de Estados</h2>
                    <button onclick="openModal('estado')" class="btn btn-primary">
                        <i data-lucide="plus"></i>
                        Agregar
                    </button>
                </div>
                <div class="table-controls">
                    <div class="search-box">
                        <i data-lucide="search" class="search-icon"></i>
                        <input type="text" id="estados-search" class="search-input" placeholder="Buscar estados...">
                    </div>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Descripci√≥n</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="estados-table">
                            <tr><td colspan="2" class="text-center"><div class="loading"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Entregas -->
            <div id="entregas" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">Gesti√≥n de Entregas</h2>
                    <button onclick="openModal('entrega')" class="btn btn-primary">
                        <i data-lucide="plus"></i>
                        Agregar
                    </button>
                </div>
                <div class="table-controls">
                    <div class="search-box">
                        <i data-lucide="search" class="search-icon"></i>
                        <input type="text" id="entregas-search" class="search-input" placeholder="Buscar entregas...">
                    </div>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Descripci√≥n</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="entregas-table">
                            <tr><td colspan="2" class="text-center"><div class="loading"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

                    <!-- Tipos de Contacto -->
            <div id="tipos-contacto" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">Tipos de Contacto</h2>
                    <button onclick="openModal('tipos-contacto')" class="btn btn-primary">
                        <i data-lucide="plus"></i>
                        Agregar
                    </button>
                </div>
                <div class="table-controls">
                    <div class="search-box">
                        <i data-lucide="search" class="search-icon"></i>
                        <input type="text" id="tipos-contacto-search" class="search-input" placeholder="Buscar tipos...">
                    </div>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Descripci√≥n</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tipos-contacto-table">
                            <tr><td colspan="2" class="text-center"><div class="loading"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="reportes-productos" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">Reporte Comparativo de Productos</h2>
                </div>

                <!-- Filtros de Productos -->
                <div class="filters-container">
                    <div class="filters-title">
                        <i data-lucide="filter"></i>
                        Filtros de An√°lisis
                    </div>
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label class="filter-label">Fecha Desde</label>
                            <input type="date" id="productos-fecha-desde" class="filter-input">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Fecha Hasta</label>
                            <input type="date" id="productos-fecha-hasta" class="filter-input">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Producto Espec√≠fico</label>
                            <select id="productos-filtro-producto" class="filter-select">
                                <option value="">Todos los productos</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Tipo de An√°lisis</label>
                            <select id="productos-tipo-analisis" class="filter-select">
                                <option value="completo">An√°lisis Completo</option>
                                <option value="solo-ventas">Solo Ventas</option>
                                <option value="solo-compras">Solo Compras</option>
                                <option value="mas-vendidos">M√°s Vendidos</option>
                                <option value="mas-comprados">M√°s Comprados</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Cantidad M√≠nima</label>
                            <input type="number" id="productos-cantidad-minima" class="filter-input" placeholder="0" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Agrupar por:</label>
                            <select id="productos-agrupacion" class="form-input" onchange="window.reportesProductos?.actualizarGraficoProductos()">
                                <option value="a√±o">üìÖ A√±o</option>
                                <option value="mes" selected>üìÜ Mes</option>
                                <option value="semana">üìä Semana</option>
                                <option value="dia">üóìÔ∏è D√≠a</option>
                            </select>
                        </div>
                    </div>
                    <div class="filters-actions">
                        <button onclick="window.reportesProductos?.aplicarFiltros()" class="btn btn-primary">
                            <i data-lucide="search"></i>
                            Generar Reporte
                        </button>
                        <button onclick="window.reportesProductos?.limpiarFiltros()" class="btn btn-secondary">
                            <i data-lucide="x-circle"></i>
                            Limpiar
                        </button>
                        <button onclick="window.reportesManager?.exportarProductos()" class="btn btn-primary">
                            <i data-lucide="download"></i>
                            Exportar Excel
                        </button>
                    </div>
                </div>

                <!-- Estad√≠sticas Generales -->
                <div class="stats-grid" id="productos-stats">
                    <div class="stat-card blue">
                        <div class="stat-number" id="productos-total-analizados">0</div>
                        <div class="stat-label">Productos Analizados</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-number" id="productos-total-vendidos">0</div>
                        <div class="stat-label">Total Vendidos</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-number" id="productos-total-comprados">0</div>
                        <div class="stat-label">Total Comprados</div>
                    </div>
                    <div class="stat-card purple">
                        <div class="stat-number" id="productos-valor-ventas">S/ 0</div>
                        <div class="stat-label">Valor en Ventas</div>
                    </div>
                    <div class="stat-card yellow">
                        <div class="stat-number" id="productos-valor-compras">S/ 0</div>
                        <div class="stat-label">Valor en Compras</div>
                    </div>
                    <div class="stat-card indigo">
                        <div class="stat-number" id="productos-margen">S/ 0</div>
                        <div class="stat-label">Margen Estimado</div>
                    </div>
                </div>

                <!-- Gr√°ficos Comparativos -->
                <div class="charts-row">
                    <div class="chart-container" style="flex: 1; margin-right: 1rem;">
                        <div class="chart-title">Top 10 Productos M√°s Vendidos</div>
                        <canvas id="ventasProductosChart" width="400" height="300"></canvas>
                    </div>
                    <div class="chart-container" style="flex: 1; margin-left: 1rem;">
                        <div class="chart-title">Top 10 Productos M√°s Comprados</div>
                        <canvas id="comprasProductosChart" width="400" height="300"></canvas>
                    </div>
                </div>

                <!-- Tabla Comparativa -->
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Stock Actual</th>
                                <th>Cantidad Vendida</th>
                                <th>Valor Ventas</th>
                                <th>Cantidad Comprada</th>
                                <th>Valor Compras</th>
                                <th>Balance</th>
                                <th>Margen Est.</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="productos-table-reports">
                            <tr><td colspan="9" class="text-center"><div class="loading"></div></td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- An√°lisis Detallado -->
                <div id="productos-analisis-detallado" class="analysis-section" style="display: none;">
                    <h3>An√°lisis Detallado</h3>
                    <div class="analysis-grid">
                        <div class="analysis-card">
                            <h4>Productos con Mayor Rotaci√≥n</h4>
                            <div id="productos-mayor-rotacion"></div>
                        </div>
                        <div class="analysis-card">
                            <h4>Productos con Stock Cr√≠tico</h4>
                            <div id="productos-stock-critico"></div>
                        </div>
                        <div class="analysis-card">
                            <h4>Oportunidades de Compra</h4>
                            <div id="productos-oportunidades"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="balance" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">Balance de Ingresos y Egresos</h2>
                </div>

                <!-- Filtros de Fecha -->
                <div class="filters-container">
                    <div class="filters-title">
                        <i data-lucide="calendar"></i>
                        Filtros de Per√≠odo
                    </div>
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label class="filter-label">Fecha Desde</label>
                            <input type="date" id="balance-fecha-desde" class="filter-input">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Fecha Hasta</label>
                            <input type="date" id="balance-fecha-hasta" class="filter-input">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Incluir Datos Autom√°ticos</label>
                            <select id="balance-incluir-automaticos" class="filter-select">
                                <option value="si">S√≠ (Ventas y Compras)</option>
                                <option value="no">No (Solo Manual)</option>
                            </select>
                        </div>
                    </div>
                    <div class="filters-actions">
                        <button onclick="window.balanceManager?.calcularAutomatico()" class="btn btn-primary">
                            <i data-lucide="refresh-cw"></i>
                            Calcular Balance
                        </button>
                        <button onclick="window.balanceManager?.limpiarBalance()" class="btn btn-secondary">
                            <i data-lucide="x-circle"></i>
                            Limpiar
                        </button>
                        <button onclick="window.balanceManager?.exportarBalance()" class="btn btn-success">
                            <i data-lucide="download"></i>
                            Exportar Excel
                        </button>
                    </div>
                </div>

                <!-- Resumen del Balance -->
                <div class="balance-summary">
                    <div class="summary-card ingresos">
                        <div class="summary-icon">
                            <i data-lucide="trending-up"></i>
                        </div>
                        <div class="summary-content">
                            <div class="summary-label">Total Ingresos</div>
                            <div class="summary-amount" id="total-ingresos">S/ 0.00</div>
                        </div>
                    </div>
                    
                    <div class="summary-card egresos">
                        <div class="summary-icon">
                            <i data-lucide="trending-down"></i>
                        </div>
                        <div class="summary-content">
                            <div class="summary-label">Total Egresos</div>
                            <div class="summary-amount" id="total-egresos">S/ 0.00</div>
                        </div>
                    </div>
                    
                    <div class="summary-card balance" id="balance-resultado">
                        <div class="summary-icon">
                            <i data-lucide="dollar-sign"></i>
                        </div>
                        <div class="summary-content">
                            <div class="summary-label">Balance Final</div>
                            <div class="summary-amount" id="balance-final">S/ 0.00</div>
                        </div>
                    </div>
                </div>

                <!-- Tablas de Ingresos y Egresos -->
                <div class="balance-tables">
                    <!-- Secci√≥n de Ingresos -->
                    <div class="balance-section">
                        <div class="section-header-small">
                            <h3>Ingresos</h3>
                            <button onclick="window.balanceManager?.agregarFila('ingresos')" class="btn btn-success btn-small">
                                <i data-lucide="plus"></i>
                                Agregar Ingreso
                            </button>
                        </div>
                        
                        <div class="table-container">
                            <table class="table balance-table">
                                <thead>
                                    <tr>
                                        <th style="width: 60%;">Concepto</th>
                                        <th style="width: 25%;">Monto (S/)</th>
                                        <th style="width: 15%;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="ingresos-table">
                                    <!-- Filas din√°micas -->
                                </tbody>
                                <tfoot>
                                    <tr class="total-row">
                                        <td><strong>TOTAL INGRESOS</strong></td>
                                        <td><strong id="subtotal-ingresos">S/ 0.00</strong></td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <!-- Secci√≥n de Egresos -->
                    <div class="balance-section">
                        <div class="section-header-small">
                            <h3>Egresos</h3>
                            <button onclick="window.balanceManager?.agregarFila('egresos')" class="btn btn-danger btn-small">
                                <i data-lucide="plus"></i>
                                Agregar Egreso
                            </button>
                        </div>
                        
                        <div class="table-container">
                            <table class="table balance-table">
                                <thead>
                                    <tr>
                                        <th style="width: 60%;">Concepto</th>
                                        <th style="width: 25%;">Monto (S/)</th>
                                        <th style="width: 15%;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="egresos-table">
                                    <!-- Filas din√°micas -->
                                </tbody>
                                <tfoot>
                                    <tr class="total-row">
                                        <td><strong>TOTAL EGRESOS</strong></td>
                                        <td><strong id="subtotal-egresos">S/ 0.00</strong></td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- An√°lisis del Balance -->
                <div class="balance-analysis">
                    <div class="analysis-card">
                        <h4>An√°lisis del Per√≠odo</h4>
                        <div id="balance-analisis-texto">
                            Seleccione un per√≠odo y haga clic en "Calcular Balance" para ver el an√°lisis.
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="cambiar-password" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">Cambiar Contrase√±a</h2>
                </div>

                <div class="password-change-container">
                    <div class="user-info-card">
                        <div class="user-avatar">
                            <i data-lucide="user"></i>
                        </div>
                        <div class="user-details">
                            <h3 id="user-name-display">Usuario</h3>
                            <p id="user-dni-display">DNI: </p>
                            <p class="user-note">Cambia tu contrase√±a de acceso al sistema</p>
                        </div>
                    </div>

                    <form class="password-form" id="passwordChangeForm">
                        <div class="form-section">
                            <h4>Informaci√≥n de Seguridad</h4>
                            
                            <div class="form-group">
                                <label class="form-label" for="current-password">Contrase√±a Actual</label>
                                <div class="input-group">
                                    <i class="input-icon" data-lucide="lock"></i>
                                    <input 
                                        type="password" 
                                        id="current-password" 
                                        name="current-password" 
                                        class="form-input" 
                                        placeholder="Ingresa tu contrase√±a actual"
                                        required
                                        autocomplete="current-password"
                                    >
                                    <button type="button" class="password-toggle-btn" onclick="togglePasswordVisibility('current-password')">
                                        <i data-lucide="eye"></i>
                                    </button>
                                </div>
                                <small class="input-help">Por defecto es tu DNI si no la has cambiado antes</small>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="new-password">Nueva Contrase√±a</label>
                                <div class="input-group">
                                    <i class="input-icon" data-lucide="key"></i>
                                    <input 
                                        type="password" 
                                        id="new-password" 
                                        name="new-password" 
                                        class="form-input" 
                                        placeholder="Ingresa tu nueva contrase√±a"
                                        required
                                        autocomplete="new-password"
                                        minlength="4"
                                    >
                                    <button type="button" class="password-toggle-btn" onclick="togglePasswordVisibility('new-password')">
                                        <i data-lucide="eye"></i>
                                    </button>
                                </div>
                                <div class="password-strength" id="password-strength">
                                    <div class="strength-bar">
                                        <div class="strength-fill" id="strength-fill"></div>
                                    </div>
                                    <span class="strength-text" id="strength-text">Ingresa una contrase√±a</span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="confirm-password">Confirmar Nueva Contrase√±a</label>
                                <div class="input-group">
                                    <i class="input-icon" data-lucide="check-circle"></i>
                                    <input 
                                        type="password" 
                                        id="confirm-password" 
                                        name="confirm-password" 
                                        class="form-input" 
                                        placeholder="Confirma tu nueva contrase√±a"
                                        required
                                        autocomplete="new-password"
                                    >
                                    <button type="button" class="password-toggle-btn" onclick="togglePasswordVisibility('confirm-password')">
                                        <i data-lucide="eye"></i>
                                    </button>
                                </div>
                                <div class="password-match" id="password-match"></div>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="change-password-btn">
                                <i data-lucide="save"></i>
                                Cambiar Contrase√±a
                            </button>
                            <button type="button" onclick="clearPasswordForm()" class="btn btn-secondary">
                                <i data-lucide="x-circle"></i>
                                Cancelar
                            </button>
                        </div>
                    </form>

                    <div class="password-tips">
                        <h4>Consejos de Seguridad</h4>
                        <ul>
                            <li>Usa al menos 6 caracteres para mayor seguridad</li>
                            <li>Combina letras, n√∫meros y s√≠mbolos</li>
                            <li>No uses informaci√≥n personal como fechas de nacimiento</li>
                            <li>No compartas tu contrase√±a con nadie</li>
                            <li>Cambia tu contrase√±a peri√≥dicamente</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title" class="modal-title">Agregar Registro</h3>
                <button onclick="closeModal()" class="close-btn">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form id="modal-form">
                <div id="modal-fields"></div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i data-lucide="save"></i>
                        Guardar
                    </button>
                    <button type="button" onclick="closeModal()" class="btn btn-danger">
                        <i data-lucide="x"></i>
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- JavaScript Files -->
    <script src="js/utils/validation.js"></script>
    <script src="js/utils/formatters.js"></script>
    <script src="js/utils/searchManager.js"></script>
    <script src="js/config/firebase.js"></script>
    <script src="js/services/cacheService.js"></script>
    <script src="js/services/dataService.js"></script>
    <script src="js/services/notificationService.js"></script>
    <script src="js/components/balanceManager.js"></script>
    <script src="js/components/loginManager.js"></script>
    <script src="js/components/modalManager.js"></script>
    <script src="js/components/paginationManager.js"></script>
    <script src="js/components/passwordManager.js"></script>
    <script src="js/components/pedidoDetalleManager.js"></script>
    <script src="js/components/compraDetalleManager.js"></script>
    <script src="js/components/reportesManager.js"></script>
    <script src="js/components/reportesProductos.js"></script>
    <script src="js/main.js"></script>
</body>
</html>