<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Novo CRM</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
        }

        .login-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 100%;
            max-width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
        }

        .login-header p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.875rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: white;
            font-size: 0.875rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }

        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            font-size: 0.875rem;
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(45deg, #059669, #047857);
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #fecaca;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            color: #a7f3d0;
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.2);
            color: #fde68a;
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            color: #bfdbfe;
        }

        .loading {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        @media (max-width: 480px) {
            .login-container {
                margin: 1rem;
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-header">
            <h1>Novo CRM</h1>
            <p>Inicie sesión para acceder al sistema</p>
        </div>

        <div id="alert-container"></div>

        <!-- Formulario de Login -->
        <form id="login-form">
            <div class="form-group">
                <label for="email" class="form-label">
                    <i data-lucide="mail" style="width: 16px; height: 16px; margin-right: 4px;"></i>
                    Email
                </label>
                <input 
                    type="email" 
                    id="email" 
                    class="form-input" 
                    placeholder="tu@email.com"
                    required
                    autocomplete="email"
                >
            </div>

            <div class="form-group">
                <label for="password" class="form-label">
                    <i data-lucide="lock" style="width: 16px; height: 16px; margin-right: 4px;"></i>
                    Contraseña
                </label>
                <input 
                    type="password" 
                    id="password" 
                    class="form-input" 
                    placeholder="••••••••"
                    required
                    autocomplete="current-password"
                >
            </div>

            <button type="submit" class="btn btn-primary" id="login-btn">
                <span id="login-text">
                    <i data-lucide="log-in"></i>
                    Iniciar Sesión
                </span>
                <span id="login-loading" class="hidden">
                    <div class="loading"></div>
                    Iniciando sesión...
                </span>
            </button>
        </form>
    </div>

    <!-- Scripts -->
    <script>
        // Configuración Firebase integrada
        const firebaseConfig = {
            apiKey: "AIzaSyBlzaQCL7M98QeifzkEMZ4d8deC7oHqCT0",
            authDomain: "novo-crm-e9779.firebaseapp.com",
            projectId: "novo-crm-e9779",
            storageBucket: "novo-crm-e9779.firebasestorage.app",
            messagingSenderId: "43652899432",
            appId: "1:43652899432:web:6c787bced791b8ea6d91dd"
        };
    </script>

    <script>
        // ===== CONFIGURACIÓN Y VARIABLES GLOBALES =====
        let auth;
        let db;
        let isRedirecting = false;

        // ===== INICIALIZACIÓN =====
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM cargado, inicializando login...');
            
            try {
                // Inicializar Firebase con configuración integrada
                if (typeof firebase !== 'undefined' && firebaseConfig) {
                    firebase.initializeApp(firebaseConfig);
                    auth = firebase.auth();
                    db = firebase.firestore();
                    console.log('Firebase inicializado correctamente');
                } else {
                    throw new Error('Firebase SDK no disponible');
                }

                // Inicializar iconos
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }

                // Configurar el manager de login
                window.loginManager = new LoginManager();
                
                console.log('Login inicializado exitosamente');
                
            } catch (error) {
                console.error('Error inicializando:', error);
                showAlert('Error de inicialización: ' + error.message, 'error');
                
                // Mostrar información para desarrollo
                if (window.location.hostname === 'localhost') {
                    setTimeout(() => {
                        showAlert('Firebase no disponible. Verifica tu conexión y configuración.', 'warning');
                    }, 2000);
                }
            }
        });

        // ===== LOGIN MANAGER =====
        class LoginManager {
            constructor() {
                this.form = document.getElementById('login-form');
                this.emailInput = document.getElementById('email');
                this.passwordInput = document.getElementById('password');
                
                this.setupEventListeners();
                
                // Verificar si hay usuario autenticado después del período de gracia
                setTimeout(() => {
                    this.checkAuthState();
                }, 3000);
            }

            setupEventListeners() {
                this.form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });

                this.emailInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.passwordInput.focus();
                    }
                });

                this.passwordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.handleLogin();
                    }
                });

                this.emailInput.addEventListener('input', clearAlerts);
                this.passwordInput.addEventListener('input', clearAlerts);
            }

            async checkAuthState() {
                if (!auth) return;

                try {
                    const user = auth.currentUser;
                    if (user) {
                        console.log('Usuario autenticado encontrado:', user.email);
                        
                        // Verificar si el usuario está activo en Firestore
                        const userDoc = await db.collection('usuarios').doc(user.uid).get();
                        if (userDoc.exists && userDoc.data().activo) {
                            const userData = userDoc.data();
                            
                            const shouldRedirect = confirm(
                                `Sesión activa encontrada para ${userData.nombre}.\n¿Continuar con esta sesión?`
                            );
                            
                            if (shouldRedirect) {
                                this.redirectToIndex();
                            } else {
                                await auth.signOut();
                                showAlert('Sesión cerrada. Puedes iniciar sesión con otra cuenta.', 'info');
                            }
                        } else {
                            await auth.signOut();
                            showAlert('Usuario no encontrado o desactivado.', 'error');
                        }
                    }
                } catch (error) {
                    console.error('Error verificando estado de auth:', error);
                }
            }

            async handleLogin() {
                const email = this.emailInput.value.trim();
                const password = this.passwordInput.value;

                if (!email || !password) {
                    showAlert('Por favor ingresa email y contraseña', 'error');
                    return;
                }

                try {
                    setLoading(true);
                    clearAlerts();

                    console.log('Intentando login con:', email);

                    // Autenticación con Firebase
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    const user = userCredential.user;

                    console.log('Login exitoso:', user.email);

                    // Verificar datos del usuario en Firestore
                    const userDoc = await db.collection('usuarios').doc(user.uid).get();
                    
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        
                        if (userData.activo) {
                            console.log(`Usuario verificado: ${userData.nombre} (${userData.rol})`);
                            
                            showAlert(`¡Bienvenido ${userData.nombre}! Redirigiendo...`, 'success');
                            
                            // Actualizar último acceso
                            await db.collection('usuarios').doc(user.uid).update({
                                fechaUltimoAcceso: new Date().toISOString()
                            });

                            // Redirigir después de un breve delay
                            setTimeout(() => {
                                this.redirectToIndex();
                            }, 2000);
                            
                        } else {
                            await auth.signOut();
                            throw new Error('Usuario desactivado. Contacta al administrador.');
                        }
                    } else {
                        await auth.signOut();
                        throw new Error('Perfil de usuario no encontrado.');
                    }
                    
                } catch (error) {
                    console.error('Error en login:', error);
                    this.handleLoginError(error);
                } finally {
                    setLoading(false);
                }
            }

            handleLoginError(error) {
                let errorMessage = 'Error al iniciar sesión';
                
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'Usuario no encontrado';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Contraseña incorrecta';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Email inválido';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = 'Usuario deshabilitado';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Demasiados intentos. Intenta más tarde';
                        break;
                    case 'auth/invalid-credential':
                        errorMessage = 'Credenciales inválidas';
                        break;
                    default:
                        errorMessage = error.message;
                        break;
                }
                
                showAlert(errorMessage, 'error');
            }

            redirectToIndex() {
                if (isRedirecting) return;
                
                isRedirecting = true;
                console.log('Redirigiendo a index.html...');
                
                try {
                    window.location.replace('index.html');
                } catch (error) {
                    console.error('Error en redirección:', error);
                    window.location.href = 'index.html';
                }
            }
        }

        // ===== FUNCIONES AUXILIARES =====
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container');
            const alertClass = `alert-${type}`;
            
            alertContainer.innerHTML = `
                <div class="alert ${alertClass}">
                    ${getAlertIcon(type)} ${message}
                </div>
            `;
        }

        function getAlertIcon(type) {
            switch (type) {
                case 'success': return '<i data-lucide="check-circle" style="width: 16px; height: 16px; margin-right: 8px;"></i>';
                case 'error': return '<i data-lucide="x-circle" style="width: 16px; height: 16px; margin-right: 8px;"></i>';
                case 'warning': return '<i data-lucide="alert-triangle" style="width: 16px; height: 16px; margin-right: 8px;"></i>';
                default: return '<i data-lucide="info" style="width: 16px; height: 16px; margin-right: 8px;"></i>';
            }
        }

        function clearAlerts() {
            document.getElementById('alert-container').innerHTML = '';
        }

        function setLoading(loading) {
            const loginBtn = document.getElementById('login-btn');
            const loginText = document.getElementById('login-text');
            const loginLoading = document.getElementById('login-loading');
            
            loginBtn.disabled = loading;
            
            if (loading) {
                loginText.classList.add('hidden');
                loginLoading.classList.remove('hidden');
            } else {
                loginText.classList.remove('hidden');
                loginLoading.classList.add('hidden');
            }
        }

        // ===== FUNCIONES GLOBALES PARA DEBUG =====
        window.forceCompleteLogout = function() {
            console.log('Ejecutando logout forzado completo...');
            
            if (auth) {
                auth.signOut().catch(console.warn);
            }
            
            localStorage.clear();
            sessionStorage.clear();
            
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        };
    </script>

    <!-- PARCHE ANTI-REDIRECCIÓN -->
    <script>
        (function() {
            console.log('Aplicando parche anti-redirección en login.html...');
            
            // 1. Verificar si venimos de un logout
            const urlParams = new URLSearchParams(window.location.search);
            const fromLogout = urlParams.get('logout') === 'true' || urlParams.get('logout') === 'forced';
            const referrer = document.referrer;
            
            console.log('Estado de login:', {
                fromLogout,
                referrer: referrer.substring(0, 50),
                pathname: window.location.pathname,
                search: window.location.search
            });
            
            // 2. Si venimos de logout, limpiar estado persistente
            if (fromLogout || referrer.includes('index.html')) {
                console.log('Detectado logout, limpiando estado persistente...');
                
                // Limpiar Firebase auth state
                if (window.firebase && window.firebase.auth) {
                    try {
                        const auth = window.firebase.auth();
                        auth.signOut().catch(err => console.warn('Error en signOut:', err));
                        console.log('Firebase signOut ejecutado');
                    } catch (e) {
                        console.warn('Error accediendo a Firebase auth:', e);
                    }
                }
                
                // Limpiar storage
                const keysToClean = [
                    'authUser', 'currentUser', 'userSession', 'dev_session',
                    'firebase:authUser', 'firebase:host', 'redirectAfterLogin'
                ];
                
                keysToClean.forEach(key => {
                    localStorage.removeItem(key);
                    sessionStorage.removeItem(key);
                });
                
                // Limpiar claves que contengan 'firebase'
                Object.keys(localStorage).forEach(key => {
                    if (key.includes('firebase:') || key.includes('auth') || key.includes('user')) {
                        localStorage.removeItem(key);
                    }
                });
                
                // Limpiar URL parameters
                if (window.history && window.history.replaceState) {
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
                
                console.log('Estado de logout limpiado completamente');
            }
            
            // 3. Variable para controlar redirecciones
            let allowRedirects = false;
            const pageLoadTime = Date.now();
            
            // 4. Interceptar intentos de redirección
            function blockRedirection(event) {
                if (!allowRedirects && (Date.now() - pageLoadTime < 5000)) {
                    const url = event.target?.href || event.detail?.url || '';
                    if (url.includes('index.html') || url.includes('index')) {
                        console.log('Bloqueando redirección automática a:', url);
                        event.preventDefault();
                        event.stopPropagation();
                        return false;
                    }
                }
            }
            
            document.addEventListener('click', blockRedirection, true);
            
            // 5. Función segura para interceptar window.location
            const originalReplace = window.location.replace.bind(window.location);
            
            function safeLocationReplace(url) {
                if (!allowRedirects && url.includes('index') && (Date.now() - pageLoadTime < 5000)) {
                    console.log('Bloqueando location.replace a:', url);
                    return Promise.resolve();
                }
                return originalReplace(url);
            }
            
            // Solo redefinir si no está ya redefinido
            if (window.location.replace.toString().includes('[native code]')) {
                try {
                    Object.defineProperty(window.location, 'replace', {
                        configurable: true,
                        writable: false,
                        value: safeLocationReplace
                    });
                    console.log('Interceptor de location.replace instalado');
                } catch (defineError) {
                    console.warn('No se pudo redefinir location.replace:', defineError.message);
                    window.location.replace = safeLocationReplace;
                }
            }
            
            // 6. Permitir redirecciones después del período de gracia
            setTimeout(() => {
                allowRedirects = true;
                console.log('Período de gracia terminado - redirecciones habilitadas');
                
                try {
                    if (originalReplace) {
                        window.location.replace = originalReplace;
                    }
                } catch (restoreError) {
                    console.warn('Error restaurando location.replace:', restoreError.message);
                }
                
                document.removeEventListener('click', blockRedirection, true);
                
            }, 5000); // 5 segundos de gracia
            
            console.log('Parche anti-redirección aplicado completamente');
        })();

        // Agregar botón de debug en desarrollo
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            setTimeout(() => {
                if (!document.getElementById('debug-logout-btn')) {
                    const debugButton = document.createElement('button');
                    debugButton.id = 'debug-logout-btn';
                    debugButton.innerHTML = 'Logout Forzado';
                    debugButton.onclick = window.forceCompleteLogout;
                    debugButton.style.cssText = `
                        position: fixed;
                        bottom: 20px;
                        right: 20px;
                        background: #ef4444;
                        color: white;
                        border: none;
                        padding: 0.5rem 1rem;
                        border-radius: 0.5rem;
                        cursor: pointer;
                        z-index: 9999;
                        font-size: 0.875rem;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    `;
                    debugButton.title = 'Limpiar completamente la sesión';
                    document.body.appendChild(debugButton);
                }
            }, 3000);
        }
    </script>
</body>
</html>